{% extends "base.html" %}

{% block title %}ArcoSTEM - Gerador de Imagens{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">

<div class="chat-container">
    <!-- Sidebar -->
    <aside class="chat-sidebar">
        <div class="sidebar-header">
            <h3>Conversas</h3>
        </div>

        <!-- Chat history (auto-loaded via HTMX) -->
        <div class="chat-list"
             id="chat-list"
             hx-get="/components/chat-sidebar?session_id={{ session_id }}"
             hx-trigger="load">
            <div class="loading">Carregando...</div>
        </div>

        <!-- New chat button -->
        <div class="sidebar-footer">
            <button class="btn-new-chat"
                    hx-get="/components/initial-view"
                    hx-target="#main-content"
                    hx-swap="innerHTML"
                    hx-push-url="/">
                + Novo chat
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="chat-main" id="main-content">
        {% if chat_id %}
            <!-- Existing chat view -->
            <div class="chat-header">
                <h2>{{ chat_title or "Chat" }}</h2>
            </div>

            <!-- Messages area -->
            <div class="messages-container"
                 id="messages-container"
                 hx-get="/components/chat-messages/{{ chat_id }}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="loading">Carregando mensagens...</div>
            </div>

            <!-- Input form -->
            <div class="chat-input-container"
                 id="chat-input-container"
                 hx-get="/components/chat-input?chat_id={{ chat_id }}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
            </div>
        {% else %}
            <!-- Initial state: PDF upload + carousel -->
            <div class="initial-view">
                <!-- Header -->
                <div class="welcome-header">
                    <div class="logo-icon">
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                            <circle cx="15" cy="30" r="8" fill="#667eea"/>
                            <circle cx="30" cy="20" r="8" fill="#764ba2"/>
                            <circle cx="45" cy="30" r="8" fill="#667eea"/>
                            <line x1="15" y1="30" x2="30" y2="20" stroke="#667eea" stroke-width="3"/>
                            <line x1="30" y1="20" x2="45" y2="30" stroke="#667eea" stroke-width="3"/>
                        </svg>
                    </div>
                    <h1>ArcoSTEM - Seu gerador de imagens</h1>
                    <p class="subtitle">Auxiliando professores a criar as melhores imagens</p>
                </div>

                <!-- PDF Upload Area -->
                <div class="pdf-upload-section">
                    <h3>Envie sua questÃ£o (PDF)</h3>
                    <form class="pdf-upload-form"
                          hx-post="/api/chat/upload-pdf"
                          hx-encoding="multipart/form-data"
                          hx-target="#upload-result"
                          hx-indicator="#pdf-loading">

                        <div class="upload-area" id="upload-area">
                            <input type="file"
                                   id="pdf-file"
                                   name="file"
                                   accept="application/pdf"
                                   required
                                   onchange="updateFileName(this)">
                            <label for="pdf-file" class="upload-label">
                                <div class="upload-icon">ðŸ“„</div>
                                <div class="upload-text">
                                    <p><strong>Clique para selecionar</strong> ou arraste um arquivo PDF</p>
                                    <p class="upload-hint">MÃ¡ximo 10MB</p>
                                </div>
                                <div id="file-name" class="file-name"></div>
                            </label>
                        </div>

                        <button type="submit" class="btn-upload">Enviar PDF</button>
                        <div id="pdf-loading" class="loading htmx-indicator">Processando PDF...</div>
                    </form>

                    <div id="upload-result" class="upload-result"></div>
                </div>

                <!-- Image Carousel -->
                <div class="carousel-section">
                    <h3>Exemplos de imagens geradas</h3>
                    <div class="carousel-container"
                         hx-get="/components/chat-carousel"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="loading">Carregando exemplos...</div>
                    </div>
                </div>
            </div>
        {% endif %}
    </main>
</div>

<script>
// Update file name display
function updateFileName(input) {
    const fileNameDiv = document.getElementById('file-name');
    if (input.files && input.files[0]) {
        fileNameDiv.textContent = input.files[0].name;
    }
}

// After successful PDF upload, create a new chat and start conversation
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'upload-result' && event.detail.successful) {
        const response = JSON.parse(event.detail.xhr.response);
        if (response.status === 'success') {
            // Show preview
            const resultDiv = document.getElementById('upload-result');
            resultDiv.innerHTML = `
                <div class="upload-success">
                    <p><strong>âœ“ PDF carregado com sucesso!</strong></p>
                    <p><em>${response.filename}</em></p>
                    <p>Texto extraÃ­do: ${response.text_length} caracteres</p>
                    <details>
                        <summary>Ver prÃ©via do texto</summary>
                        <p class="text-preview">${response.extracted_text_preview}</p>
                    </details>
                    <button class="btn-start-chat" onclick="startChatWithPDF('${response.file_id}', '${response.filename}')">
                        Iniciar conversa com este PDF
                    </button>
                </div>
            `;
        }
    }
});

// Start chat with uploaded PDF
function startChatWithPDF(fileId, filename) {
    // Create new chat
    fetch('/api/chat/new', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title: `PDF: ${filename}`})
    })
    .then(response => response.json())
    .then(data => {
        // Redirect to chat page with file_id
        window.location.href = `/chat/${data.chat_id}?file_id=${fileId}`;
    })
    .catch(error => {
        console.error('Error creating chat:', error);
        alert('Erro ao criar conversa. Tente novamente.');
    });
}
</script>
{% endblock %}
